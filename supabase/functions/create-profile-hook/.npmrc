import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

// Este é o código principal da função
Deno.serve(async (req) => {
  // 1. Verificamos se o método é POST (os hooks são sempre POST)
  if (req.method !== 'POST') {
    return new Response(JSON.stringify({ error: 'Method Not Allowed' }), {
      status: 405,
      headers: { 'Content-Type': 'application/json' },
    })
  }

  try {
    // 2. Criamos um cliente de Admin.
    // Este cliente especial ignora a RLS e pode escrever em qualquer tabela.
    const supabaseAdmin = createClient(
      Deno.env.get('SUPABASE_URL') ?? '',
      Deno.env.get('SUPABASE_SERVICE_ROLE_KEY') ?? ''
    )

    // 3. Obtemos os dados do novo utilizador (o 'record') vindos do Auth Hook
    const { record: user } = await req.json()
    
    // Verificação de segurança: Se 'user' não existir, algo está errado.
    if (!user) {
      throw new Error('User record not found in request body');
    }

    // 4. Extraímos os dados de que precisamos.
    //    Para o Google, os dados vêm de 'raw_user_meta_data'
    //    Para Email, vêm do 'email' e do 'options.data' 
    const userId = user.id
    const userEmail = user.email
    const provider = user.app_metadata.provider || 'email' // 'email' ou 'google', etc.
    
    // Tentamos obter o nome e a foto de vários locais possíveis
    const fullName = user.raw_user_meta_data?.full_name || 
                     user.raw_user_meta_data?.name || 
                     user.user_metadata?.full_name || 
                     null
                     
    const avatarUrl = user.raw_user_meta_data?.avatar_url || 
                      user.raw_user_meta_data?.picture || 
                      user.user_metadata?.avatar_url || 
                      null

    // 5. Preparamos a nova linha para a *sua* tabela 'users'
    //    (Isto corresponde exatamente ao seu esquema da imagem: external_id, full_name, etc.)
    const newProfile = {
      external_id: userId,          // O ID do auth.users (uuid)
      email: userEmail,
      full_name: fullName,
      profile_image_url: avatarUrl,
      external_provider: provider
      // A sua coluna 'id' (int4) será preenchida automaticamente pelo Postgres
    }

    // 6. Inserimos a nova linha na tabela 'users'
    const { error } = await supabaseAdmin.from('users').insert(newProfile)

    if (error) {
      console.error('Erro ao inserir perfil:', error)
      throw error // Lança o erro para ser apanhado pelo catch
    }

    // 7. Retornamos sucesso
    return new Response(JSON.stringify({ message: 'Perfil criado com sucesso!' }), {
      status: 200,
      headers: { 'Content-Type': 'application/json' },
    })

  } catch (err) {
    console.error('Erro na Edge Function:', err.message)
    return new Response(JSON.stringify({ error: err.message }), {
      status: 500,
      headers: { 'Content-Type': 'application/json' },
    })
  }
})